<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="golangä¸­ç»å…¸çš„å°±æ˜¯goroutineå’Œchannelè¿™ä¸¤ä¸ªçš„è®¾è®¡ï¼Œå…¶ä¸­channelæ˜¯å¼•ç”¨CSPç†è®ºè®¾è®¡çš„ï¼Œä¸è¦ç”¨å†…å­˜æ¥é€šè®¯ï¼Œç”¨é€šè®¯æ¥è´¡çŒ®å†…å­˜ã€‚channelæä¾›ä¸€ç§è·¨goroutineé€šè®¯çš„æ–¹å¼ã€‚ channel ç»“æ„channelç±»å‹çš„å…·ä½“ç»“æ„ç”±runtime/chan.goä¸­hchanå®šä¹‰ï¼Œç»“æ„å¦‚ä¸‹ chan.go12345678910111213type hchan struct">
<meta name="keywords" content="golang">
<meta property="og:type" content="article">
<meta property="og:title" content="channel å’Œ select">
<meta property="og:url" content="http://yoursite.com/2020/08/30/chan/index.html">
<meta property="og:site_name" content="é»„å°‘æ°">
<meta property="og:description" content="golangä¸­ç»å…¸çš„å°±æ˜¯goroutineå’Œchannelè¿™ä¸¤ä¸ªçš„è®¾è®¡ï¼Œå…¶ä¸­channelæ˜¯å¼•ç”¨CSPç†è®ºè®¾è®¡çš„ï¼Œä¸è¦ç”¨å†…å­˜æ¥é€šè®¯ï¼Œç”¨é€šè®¯æ¥è´¡çŒ®å†…å­˜ã€‚channelæä¾›ä¸€ç§è·¨goroutineé€šè®¯çš„æ–¹å¼ã€‚ channel ç»“æ„channelç±»å‹çš„å…·ä½“ç»“æ„ç”±runtime/chan.goä¸­hchanå®šä¹‰ï¼Œç»“æ„å¦‚ä¸‹ chan.go12345678910111213type hchan struct">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2021-10-04T11:23:16.534Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="channel å’Œ select">
<meta name="twitter:description" content="golangä¸­ç»å…¸çš„å°±æ˜¯goroutineå’Œchannelè¿™ä¸¤ä¸ªçš„è®¾è®¡ï¼Œå…¶ä¸­channelæ˜¯å¼•ç”¨CSPç†è®ºè®¾è®¡çš„ï¼Œä¸è¦ç”¨å†…å­˜æ¥é€šè®¯ï¼Œç”¨é€šè®¯æ¥è´¡çŒ®å†…å­˜ã€‚channelæä¾›ä¸€ç§è·¨goroutineé€šè®¯çš„æ–¹å¼ã€‚ channel ç»“æ„channelç±»å‹çš„å…·ä½“ç»“æ„ç”±runtime/chan.goä¸­hchanå®šä¹‰ï¼Œç»“æ„å¦‚ä¸‹ chan.go12345678910111213type hchan struct">





  
  
  <link rel="canonical" href="http://yoursite.com/2020/08/30/chan/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>channel å’Œ select | é»„å°‘æ°</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">é»„å°‘æ°</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">ä¸ªäººåšå®¢</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>é¦–é¡µ</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>å…³äº</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>æ ‡ç­¾</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>åˆ†ç±»</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>å½’æ¡£</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/Socketsj" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/30/chan/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="é»„å°‘æ°">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="é»„å°‘æ°">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">channel å’Œ select

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-08-30 20:46:40" itemprop="dateCreated datePublished" datetime="2020-08-30T20:46:40+08:00">2020-08-30</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-10-04 19:23:16" itemprop="dateModified" datetime="2021-10-04T19:23:16+08:00">2021-10-04</time>
              
            
          </span>
          
            <span class="post-updated">
              &nbsp; | &nbsp; æ›´æ–°äº
              <time itemprop="dateUpdated" datetime="2021-10-04T19:23:16+08:00" content="2021-10-04">
                2021-10-04
              </time>
            </span>
          
          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/golang/" itemprop="url" rel="index"><span itemprop="name">golang</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><meta name="referrer" content="no-referrer"><br> golangä¸­ç»å…¸çš„å°±æ˜¯goroutineå’Œchannelè¿™ä¸¤ä¸ªçš„è®¾è®¡ï¼Œå…¶ä¸­channelæ˜¯å¼•ç”¨CSPç†è®ºè®¾è®¡çš„ï¼Œä¸è¦ç”¨å†…å­˜æ¥é€šè®¯ï¼Œç”¨é€šè®¯æ¥è´¡çŒ®å†…å­˜ã€‚channelæä¾›ä¸€ç§è·¨goroutineé€šè®¯çš„æ–¹å¼ã€‚</p>
<h2 id="channel-ç»“æ„"><a href="#channel-ç»“æ„" class="headerlink" title="channel ç»“æ„"></a>channel ç»“æ„</h2><p>channelç±»å‹çš„å…·ä½“ç»“æ„ç”±<code>runtime/chan.go</code>ä¸­<code>hchan</code>å®šä¹‰ï¼Œç»“æ„å¦‚ä¸‹</p>
<p>chan.go<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hchan <span class="keyword">struct</span> &#123;</span><br><span class="line">   qcount   <span class="keyword">uint</span>           <span class="comment">// é˜Ÿåˆ—ä¸­æ•°æ®æ€»é‡</span></span><br><span class="line">   dataqsiz <span class="keyword">uint</span>           <span class="comment">// ç¯å½¢é˜Ÿåˆ—çš„å¤§å°ï¼Œ&gt; 0è¡¨ç¤ºæœ‰ç¼“å†²ï¼Œ= 0è¡¨ç¤ºæ— ç¼“å†²</span></span><br><span class="line">   buf      unsafe.Pointer <span class="comment">// æŒ‡å‘å…ƒç´ æ•°ç»„çš„æŒ‡é’ˆï¼Œä¸€ä¸ªç¯å½¢é˜Ÿåˆ—</span></span><br><span class="line">   elemsize <span class="keyword">uint16</span>         <span class="comment">// å•ä¸ªå…ƒç´ çš„å¤§å°</span></span><br><span class="line">   closed   <span class="keyword">uint32</span>         <span class="comment">// è¡¨æ˜æ˜¯å¦closeäº†</span></span><br><span class="line">   elemtype *_type                  <span class="comment">// å…ƒç´ ç±»å‹ï¼Œinterfaceç±»å‹ç›¸å…³</span></span><br><span class="line">   sendx    <span class="keyword">uint</span>                    <span class="comment">// sendæ•°ç»„çš„ç´¢å¼•, c &lt;- i</span></span><br><span class="line">   recvx    <span class="keyword">uint</span>                    <span class="comment">// receive æ•°ç»„çš„ç´¢å¼• &lt;- c</span></span><br><span class="line">   recvq    waitq                   <span class="comment">// ç­‰å¾…recv æ•°æ®çš„goroutineçš„é“¾è¡¨</span></span><br><span class="line">   sendq    waitq                   <span class="comment">// ç­‰å¾…sendæ•°æ®çš„goroutineé“¾è¡¨</span></span><br><span class="line">   lock mutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>channelå†…ç”±ä¸€ä¸ªç¯å½¢é˜Ÿåˆ—<code>buf</code>å­˜å‚¨é€šè®¯çš„æ•°æ®ï¼Œ<code>closed</code>ä»£è¡¨æ˜¯å¦å…³é—­,<code>recvq</code>å’Œ<code>sendq</code>åˆ†åˆ«æ˜¯ç­‰å¾…è¯»å–æ•°æ®çš„goroutineçš„é“¾è¡¨å’Œç­‰å¾…sendæ•°æ®çš„goroutineé“¾è¡¨</p>
<p><code>waitq</code>æ˜¯ä¸€ä¸ªåŒå‘åˆ—è¡¨<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> waitq <span class="keyword">struct</span> &#123;</span><br><span class="line">	first *sudog  <span class="comment">// å¤´èŠ‚ç‚¹</span></span><br><span class="line">	last  *sudog  <span class="comment">// å°¾èŠ‚ç‚¹</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sudogo å­˜å‚¨goroutineå’Œå‰åèŠ‚ç‚¹çš„åŒå‘é“¾æ ‡çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">type</span> sudog <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// The following fields are protected by the hchan.lock of the</span></span><br><span class="line">	<span class="comment">// channel this sudog is blocking on. shrinkstack depends on</span></span><br><span class="line">	<span class="comment">// this for sudogs involved in channel ops.</span></span><br><span class="line"></span><br><span class="line">	g *g <span class="comment">// goroutine</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// isSelect indicates g is participating in a select, so</span></span><br><span class="line">	<span class="comment">// g.selectDone must be CAS'd to win the wake-up race.</span></span><br><span class="line">	isSelect <span class="keyword">bool</span> <span class="comment">// æ˜¯å¦åœ¨selectä¸­</span></span><br><span class="line">	next     *sudog <span class="comment">// åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">	prev     *sudog <span class="comment">// å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">	elem     unsafe.Pointer <span class="comment">// ä¼ è¾“çš„æ•°æ®æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// The following fields are never accessed concurrently.</span></span><br><span class="line">	<span class="comment">// For channels, waitlink is only accessed by g.</span></span><br><span class="line">	<span class="comment">// For semaphores, all fields (including the ones above)</span></span><br><span class="line">	<span class="comment">// are only accessed when holding a semaRoot lock.</span></span><br><span class="line"></span><br><span class="line">	acquiretime <span class="keyword">int64</span></span><br><span class="line">	releasetime <span class="keyword">int64</span></span><br><span class="line">	ticket      <span class="keyword">uint32</span></span><br><span class="line">	parent      *sudog <span class="comment">// semaRoot binary tree</span></span><br><span class="line">	waitlink    *sudog <span class="comment">// g.waiting list or semaRoot</span></span><br><span class="line">	waittail    *sudog <span class="comment">// semaRoot</span></span><br><span class="line">	c           *hchan <span class="comment">// sudog channel</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="åˆ›å»ºchannel"><a href="#åˆ›å»ºchannel" class="headerlink" title="åˆ›å»ºchannel"></a>åˆ›å»ºchannel</h2><p>è°ƒç”¨makeå‡½æ•°,å¯ä»¥åˆ›å»ºchannel,æœ€åä¼šè°ƒç”¨makechanå‡½æ•°æ¥ç”Ÿæˆ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tæ˜¯ä¼ å…¥çš„ç±»å‹, sizeæ˜¯é•¿åº¦</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makechan</span><span class="params">(t *chantype, size <span class="keyword">int</span>)</span> *<span class="title">hchan</span></span> &#123;</span><br><span class="line">	elem := t.elem</span><br><span class="line"></span><br><span class="line">	<span class="comment">// compiler checks this but be safe.</span></span><br><span class="line">    <span class="comment">// è¶…å‡ºé•¿åº¦æŠ›å¼‚å¸¸</span></span><br><span class="line">	<span class="keyword">if</span> elem.size &gt;= <span class="number">1</span>&lt;&lt;<span class="number">16</span> &#123;</span><br><span class="line">		throw(<span class="string">"makechan: invalid channel element type"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> hchanSize%maxAlign != <span class="number">0</span> || elem.align &gt; maxAlign &#123;</span><br><span class="line">		throw(<span class="string">"makechan: bad alignment"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mem, overflow := math.MulUintptr(elem.size, <span class="keyword">uintptr</span>(size))</span><br><span class="line">	<span class="keyword">if</span> overflow || mem &gt; maxAlloc-hchanSize || size &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(plainError(<span class="string">"makechan: size out of range"</span>))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Hchan does not contain pointers interesting for GC when elements stored in buf do not contain pointers.</span></span><br><span class="line">	<span class="comment">// buf points into the same allocation, elemtype is persistent.</span></span><br><span class="line">	<span class="comment">// SudoG's are referenced from their owning thread so they can't be collected.</span></span><br><span class="line">	<span class="comment">// TODO(dvyukov,rlh): Rethink when collector can move allocated objects.</span></span><br><span class="line">	<span class="keyword">var</span> c *hchan</span><br><span class="line">	<span class="keyword">switch</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> mem == <span class="number">0</span>:</span><br><span class="line">		<span class="comment">// Queue or element size is zero.</span></span><br><span class="line">		c = (*hchan)(mallocgc(hchanSize, <span class="literal">nil</span>, <span class="literal">true</span>))</span><br><span class="line">		<span class="comment">// Race detector uses this location for synchronization.</span></span><br><span class="line">		c.buf = c.raceaddr()</span><br><span class="line">	<span class="keyword">case</span> elem.ptrdata == <span class="number">0</span>:</span><br><span class="line">		<span class="comment">// Elements do not contain pointers.</span></span><br><span class="line">		<span class="comment">// Allocate hchan and buf in one call.</span></span><br><span class="line">		c = (*hchan)(mallocgc(hchanSize+mem, <span class="literal">nil</span>, <span class="literal">true</span>))</span><br><span class="line">		c.buf = add(unsafe.Pointer(c), hchanSize)</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="comment">// Elements contain pointers.</span></span><br><span class="line">		c = <span class="built_in">new</span>(hchan)</span><br><span class="line">		c.buf = mallocgc(mem, elem, <span class="literal">true</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	c.elemsize = <span class="keyword">uint16</span>(elem.size)</span><br><span class="line">	c.elemtype = elem</span><br><span class="line">	c.dataqsiz = <span class="keyword">uint</span>(size)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> debugChan &#123;</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">"makechan: chan="</span>, c, <span class="string">"; elemsize="</span>, elem.size, <span class="string">"; dataqsiz="</span>, size, <span class="string">"\n"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> åˆ›å»ºchannelè¿‡ç¨‹</p>
<ol>
<li>æ£€æŸ¥å‚æ•°åˆæ³•æ€§sizeæ˜¯å¦åˆæ³•ï¼Œåˆ›å»ºå®¹é‡æ˜¯å¦è¶…è¿‡è§„å®šå¤§å°ã€‚channel sizeä¸èƒ½å¤§äº1&lt;&lt;16</li>
<li>è‹¥åˆ›å»ºæ‰€éœ€bufå†…å­˜ä¸º0ï¼Œåˆ™æ˜¯ä¸€ä¸ªæ— buffchannelï¼Œç›´æ¥ç”³è¯·å¯¹åº”å†…å­˜ä¸ä¸ºbufåˆ†é…å¯¹åº”å†…å­˜</li>
<li>è‹¥sizeä¸ä¸º0ï¼Œä¸ºbufç”³è¯·æ‰€éœ€å†…å­˜</li>
</ol>
<h2 id="å¾€channelå‘é€æ•°æ®"><a href="#å¾€channelå‘é€æ•°æ®" class="headerlink" title="å¾€channelå‘é€æ•°æ®"></a>å¾€channelå‘é€æ•°æ®</h2><p> <code>c &lt;- 1</code>è¿™æ ·æ˜¯å¾€channelå‘é€æ•°æ®ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç”Ÿæˆä¸­é—´ä»£ç è°ƒç”¨<code>chansend1</code>å‡½æ•°å‘é€æ•°æ®ï¼Œ<code>chansend1</code>è°ƒç”¨<code>chansend</code>æ¥å‘é€æ•°æ®ï¼Œä¸»è¦é€»è¾‘éƒ½åœ¨<code>chansend</code>ä¸­</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chansend æ˜¯å¾€channelå‘é€æ•°æ®ä¸»è¦å®ç°é€»è¾‘</span></span><br><span class="line"><span class="comment">// c:å‘é€æ•°æ®çš„channelï¼Œ</span></span><br><span class="line"><span class="comment">// ep:å‘é€æ•°æ®çš„æŒ‡é’ˆ,</span></span><br><span class="line"><span class="comment">// block: å‘é€æ˜¯å¦é˜»å¡è°ƒç”¨ï¼Œå¦‚`c &lt;- 1`è¿™æ ·çš„å‘é€è¿‡ç¨‹éƒ½æ˜¯é˜»å¡è°ƒç”¨ï¼Œè‹¥bufæ»¡äº†ä¼šé˜»å¡å½“å‰goroutineï¼Œéé˜»å¡ç”¨äºselectä¸­ï¼Œè¿™ä¸ªåé¢ä¼šè®²ã€‚</span></span><br><span class="line"><span class="comment">// callerpc: debugç›¸å…³</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chansend</span><span class="params">(c *hchan, ep unsafe.Pointer, block <span class="keyword">bool</span>, callerpc <span class="keyword">uintptr</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="comment">// å¾€ç©ºchannelå‘é€æ•°æ®ä¼šä¸€ç›´é˜»å¡</span></span><br><span class="line">    <span class="comment">// goparkæ˜¯goroutineè°ƒåº¦ç›¸å…³ï¼Œè®©ä¸€ä¸ªgoroutineè¿›å…¥gowaitçŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> c == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// éé˜»å¡ç›´æ¥è¿”å›</span></span><br><span class="line">		<span class="keyword">if</span> !block &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">		gopark(<span class="literal">nil</span>, <span class="literal">nil</span>, waitReasonChanSendNilChan, traceEvGoStop, <span class="number">2</span>)</span><br><span class="line">		throw(<span class="string">"unreachable"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// éé˜»å¡æƒ…å†µchannelä¸ºç©ºæ—¶æˆ–æ•°æ®å†™æ»¡ä¸”æ²¡æœ‰ç­‰å¾…æ¥æ”¶æ•°æ®çš„goroutineæ—¶å€™è¿”å›å¤±è´¥</span></span><br><span class="line">	<span class="keyword">if</span> !block &amp;&amp; c.closed == <span class="number">0</span> &amp;&amp; ((c.dataqsiz == <span class="number">0</span> &amp;&amp; c.recvq.first == <span class="literal">nil</span>) ||</span><br><span class="line">		(c.dataqsiz &gt; <span class="number">0</span> &amp;&amp; c.qcount == c.dataqsiz)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// ä¸Šé” é˜²æ­¢data race</span></span><br><span class="line">	lock(&amp;c.lock)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾€å·²ç»å…³é—­çš„channelå†™æ•°æ®æŠ›å‡ºå¼‚å¸¸	</span></span><br><span class="line">    <span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">		unlock(&amp;c.lock)</span><br><span class="line">		<span class="built_in">panic</span>(plainError(<span class="string">"send on closed channel"</span>))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»æ¥å—è€…ç­‰å¾…é˜Ÿåˆ—æ‰¾å‡ºä¸€ä¸ªæ¥å—è€…ï¼Œè‹¥æœ‰åˆ™è°ƒç”¨send,è®©æ¥å—è€…æ¥æ”¶</span></span><br><span class="line">    <span class="comment">// sendå‡½æ•°è¿™é‡Œä¸å±•å¼€ï¼Œä¸»è¦å®Œæˆä¸€ä¸‹æ“ä½œ</span></span><br><span class="line">    <span class="comment">// 1. å°†æ•°æ®å¤åˆ¶åˆ°sudogçš„dataä¸­</span></span><br><span class="line">    <span class="comment">// 2. è°ƒç”¨goreadyè®©ç­‰å¾…goroutineè¿›å…¥goreadyçŠ¶æ€å¯ä»¥è¢«é‡æ–°å”¤é†’è°ƒç”¨</span></span><br><span class="line">    <span class="comment">// 3. è§£é™¤hchançš„é”</span></span><br><span class="line">    <span class="keyword">if</span> sg := c.recvq.dequeue(); sg != <span class="literal">nil</span> &#123;</span><br><span class="line">        send(c, sg, ep, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;   </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥bufæ˜¯å¦æ»¡äº†ï¼Œè‹¥æœªæ»¡å†™å…¥bufä¸­è¿”å›true</span></span><br><span class="line">	<span class="keyword">if</span> c.qcount &lt; c.dataqsiz &#123;</span><br><span class="line">		<span class="comment">// Space is available in the channel buffer. Enqueue the element to send.</span></span><br><span class="line">		qp := chanbuf(c, c.sendx)</span><br><span class="line">		<span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">			raceacquire(qp)</span><br><span class="line">			racerelease(qp)</span><br><span class="line">		&#125;</span><br><span class="line">		typedmemmove(c.elemtype, qp, ep)</span><br><span class="line">		c.sendx++</span><br><span class="line">		<span class="keyword">if</span> c.sendx == c.dataqsiz &#123;</span><br><span class="line">			c.sendx = <span class="number">0</span></span><br><span class="line">		&#125;</span><br><span class="line">		c.qcount++</span><br><span class="line">		unlock(&amp;c.lock)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éé˜»å¡æƒ…å†µï¼Œä¸ä¼šé˜»å¡å½“å‰goroutine ç›´æ¥è¿”å›</span></span><br><span class="line">	<span class="keyword">if</span> !block &#123;</span><br><span class="line">		unlock(&amp;c.lock)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹é¢ä¸ºé˜»å¡å½“å‰goroutineçš„æ“ä½œ</span></span><br><span class="line">    <span class="comment">// è·å–å½“å‰goroutine</span></span><br><span class="line">    <span class="comment">// å¡«å……sudğŸ˜¯gå¯¹åº”å€¼ï¼Œç„¶åå†™å…¥åˆ°ç­‰å¾…å‘é€é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="comment">// è°ƒç”¨goparkï¼Œå°†å½“å‰goroutineè¿›å…¥gowaitçŠ¶æ€</span></span><br><span class="line">    <span class="comment">// ç­‰å¾…å½“å‰goroutineè¢«å”¤é†’</span></span><br><span class="line">	gp := getg()          <span class="comment">// è·å–å½“å‰goroutine</span></span><br><span class="line">	mysg := acquireSudog()</span><br><span class="line">	mysg.releasetime = <span class="number">0</span></span><br><span class="line">	<span class="keyword">if</span> t0 != <span class="number">0</span> &#123;</span><br><span class="line">		mysg.releasetime = <span class="number">-1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// No stack splits between assigning elem and enqueuing mysg</span></span><br><span class="line">	<span class="comment">// on gp.waiting where copystack can find it.</span></span><br><span class="line">	mysg.elem = ep</span><br><span class="line">	mysg.waitlink = <span class="literal">nil</span></span><br><span class="line">	mysg.g = gp</span><br><span class="line">	mysg.isSelect = <span class="literal">false</span></span><br><span class="line">	mysg.c = c</span><br><span class="line">	gp.waiting = mysg</span><br><span class="line">	gp.param = <span class="literal">nil</span></span><br><span class="line">	c.sendq.enqueue(mysg)</span><br><span class="line">    <span class="comment">// è°ƒç”¨goparkï¼Œå°†å½“å‰goroutineè¿›å…¥gowaitçŠ¶æ€ï¼Œè§£é™¤å½“å‰hchançš„é” è¿›è¡Œé˜»å¡</span></span><br><span class="line">	gopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanSend, traceEvGoBlockSend, <span class="number">2</span>)</span><br><span class="line">	<span class="comment">// Ensure the value being sent is kept alive until the</span></span><br><span class="line">	<span class="comment">// receiver copies it out. The sudog has a pointer to the</span></span><br><span class="line">	<span class="comment">// stack object, but sudogs aren't considered as roots of the</span></span><br><span class="line">	<span class="comment">// stack tracer.</span></span><br><span class="line">	KeepAlive(ep)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// someone woke us up.</span></span><br><span class="line">	<span class="keyword">if</span> mysg != gp.waiting &#123;</span><br><span class="line">		throw(<span class="string">"G waiting list is corrupted"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	gp.waiting = <span class="literal">nil</span></span><br><span class="line">	gp.activeStackChans = <span class="literal">false</span></span><br><span class="line">	<span class="keyword">if</span> gp.param == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> c.closed == <span class="number">0</span> &#123;</span><br><span class="line">			throw(<span class="string">"chansend: spurious wakeup"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">panic</span>(plainError(<span class="string">"send on closed channel"</span>))</span><br><span class="line">	&#125;</span><br><span class="line">	gp.param = <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">if</span> mysg.releasetime &gt; <span class="number">0</span> &#123;</span><br><span class="line">		blockevent(mysg.releasetime-t0, <span class="number">2</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	mysg.c = <span class="literal">nil</span></span><br><span class="line">	releaseSudog(mysg)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ä»channelè¯»å–æ•°æ®"><a href="#ä»channelè¯»å–æ•°æ®" class="headerlink" title="ä»channelè¯»å–æ•°æ®"></a>ä»channelè¯»å–æ•°æ®</h2><p><code>a := &lt;- c</code> è¿™ä¸ªæ˜¯ä»channelè¯»å–æ•°æ®ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç”Ÿæˆä¸­é—´ä»£ç è°ƒç”¨<code>chansend1</code>å‡½æ•°å‘é€æ•°æ®ï¼Œ<code>chanrecv1</code>è°ƒç”¨<code>chanrecv</code>æ¥å‘é€æ•°æ®ï¼Œä¸»è¦é€»è¾‘éƒ½åœ¨<code>chanrecv</code>ä¸­ï¼Œä¸å‘é€æ•°æ®æœ‰äº›ç›¸ä¼¼</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chanrecv ä»channelè¯»å–æ•°æ®ä¸»è¦å®ç°é€»è¾‘</span></span><br><span class="line"><span class="comment">// c:è¯»å–æ•°æ®çš„channelï¼Œ</span></span><br><span class="line"><span class="comment">// ep:æ¥æ”¶æ•°æ®çš„æŒ‡é’ˆ,</span></span><br><span class="line"><span class="comment">// block: å‘é€æ˜¯å¦é˜»å¡è°ƒç”¨ï¼Œå¦‚`a := &lt;- c`è¿™æ ·çš„å‘é€è¿‡ç¨‹éƒ½æ˜¯é˜»å¡è°ƒç”¨ï¼Œè‹¥bufæ»¡äº†ä¼šé˜»å¡å½“å‰goroutineï¼Œéé˜»å¡ç”¨äºselectä¸­ï¼Œè¿™ä¸ªåé¢ä¼šè®²ã€‚</span></span><br><span class="line"><span class="comment">// callerpc: debugç›¸å…³</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chanrecv</span><span class="params">(c *hchan, ep unsafe.Pointer, block <span class="keyword">bool</span>)</span> <span class="params">(selected, received <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// å¾€ä¸€ä¸ªç©ºçš„channelè¯»å–æ•°æ®ä¼šä¸€ç›´é˜»å¡</span></span><br><span class="line">    <span class="keyword">if</span> c == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// éé˜»å¡ç›´æ¥è¿”å›</span></span><br><span class="line">		<span class="keyword">if</span> !block &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		gopark(<span class="literal">nil</span>, <span class="literal">nil</span>, waitReasonChanReceiveNilChan, traceEvGoStop, <span class="number">2</span>)</span><br><span class="line">		throw(<span class="string">"unreachable"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// éé˜»å¡æƒ…å†µä¸‹ï¼Œchannelçš„bufä¸ºç©ºä¸”æ²¡æœ‰å‘é€ç­‰å¾…é˜Ÿåˆ—ä¹Ÿä¸ºç©ºæ—¶å€™å¯ä»¥ç›´æ¥è¿”å›</span></span><br><span class="line">	<span class="keyword">if</span> !block &amp;&amp; (c.dataqsiz == <span class="number">0</span> &amp;&amp; c.sendq.first == <span class="literal">nil</span> ||</span><br><span class="line">		c.dataqsiz &gt; <span class="number">0</span> &amp;&amp; atomic.Loaduint(&amp;c.qcount) == <span class="number">0</span>) &amp;&amp;</span><br><span class="line">		atomic.Load(&amp;c.closed) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸Šé”é˜²æ­¢data race</span></span><br><span class="line"> 	lock(&amp;c.lock)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å·²ç»å…³é—­çš„channelä¸”bufä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">	<span class="keyword">if</span> c.closed != <span class="number">0</span> &amp;&amp; c.qcount == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">			raceacquire(c.raceaddr())</span><br><span class="line">		&#125;</span><br><span class="line">		unlock(&amp;c.lock)</span><br><span class="line">		<span class="keyword">if</span> ep != <span class="literal">nil</span> &#123;</span><br><span class="line">			typedmemclr(c.elemtype, ep)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä»å‘é€è€…ç­‰å¾…é˜Ÿåˆ—æ‰¾å‡ºä¸€ä¸ªå‘é€è€…ï¼Œè‹¥æœ‰åˆ™è°ƒç”¨recv,è®©å‘é€è€…æ¥æ”¶</span></span><br><span class="line">    <span class="comment">// sendå‡½æ•°è¿™é‡Œä¸å±•å¼€ï¼Œä¸»è¦å®Œæˆä¸€ä¸‹æ“ä½œ</span></span><br><span class="line">    <span class="comment">// 1. ä»sudogçš„dataä¸­å¤åˆ¶æ•°æ®åˆ°ep</span></span><br><span class="line">    <span class="comment">// 2. è°ƒç”¨goreadyè®©ç­‰å¾…goroutineè¿›å…¥goreadyçŠ¶æ€å¯ä»¥è¢«é‡æ–°å”¤é†’è°ƒç”¨</span></span><br><span class="line">    <span class="comment">// 3. è§£é™¤hchançš„é”</span></span><br><span class="line">	<span class="keyword">if</span> sg := c.sendq.dequeue(); sg != <span class="literal">nil</span> &#123;</span><br><span class="line">		recv(c, sg, ep, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="number">3</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// bufä¸­æœ‰æ•°æ®ï¼Œä»bufä¸­è¯»å–åè¿”å›</span></span><br><span class="line">	<span class="keyword">if</span> c.qcount &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// Receive directly from queue</span></span><br><span class="line">		qp := chanbuf(c, c.recvx)</span><br><span class="line">		<span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">			raceacquire(qp)</span><br><span class="line">			racerelease(qp)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ep != <span class="literal">nil</span> &#123;</span><br><span class="line">			typedmemmove(c.elemtype, ep, qp)</span><br><span class="line">		&#125;</span><br><span class="line">		typedmemclr(c.elemtype, qp)</span><br><span class="line">		c.recvx++</span><br><span class="line">		<span class="keyword">if</span> c.recvx == c.dataqsiz &#123;</span><br><span class="line">			c.recvx = <span class="number">0</span></span><br><span class="line">		&#125;</span><br><span class="line">		c.qcount--</span><br><span class="line">		unlock(&amp;c.lock)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éé˜»å¡ç›´æ¥è¿”å›</span></span><br><span class="line">	<span class="keyword">if</span> !block &#123;</span><br><span class="line">		unlock(&amp;c.lock)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä¸‹é¢ä¸ºé˜»å¡æ“ä½œ</span></span><br><span class="line">    <span class="comment">// è·å–å½“å‰goroutine</span></span><br><span class="line">    <span class="comment">// å¡«å……sudğŸ˜¯gå¯¹åº”å€¼ï¼Œç„¶åå†™å…¥åˆ°ç­‰å¾…æ¥æ”¶é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="comment">// è°ƒç”¨goparkï¼Œå°†å½“å‰goroutineè¿›å…¥gowaitçŠ¶æ€</span></span><br><span class="line">    <span class="comment">// ç­‰å¾…å½“å‰goroutineè¢«å”¤é†’</span></span><br><span class="line">	gp := getg()</span><br><span class="line">	mysg := acquireSudog()</span><br><span class="line">	mysg.releasetime = <span class="number">0</span></span><br><span class="line">	<span class="keyword">if</span> t0 != <span class="number">0</span> &#123;</span><br><span class="line">		mysg.releasetime = <span class="number">-1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// No stack splits between assigning elem and enqueuing mysg</span></span><br><span class="line">	<span class="comment">// on gp.waiting where copystack can find it.</span></span><br><span class="line">	mysg.elem = ep</span><br><span class="line">	mysg.waitlink = <span class="literal">nil</span></span><br><span class="line">	gp.waiting = mysg</span><br><span class="line">	mysg.g = gp</span><br><span class="line">	mysg.isSelect = <span class="literal">false</span></span><br><span class="line">	mysg.c = c</span><br><span class="line">	gp.param = <span class="literal">nil</span></span><br><span class="line">	c.recvq.enqueue(mysg)</span><br><span class="line">    <span class="comment">// è°ƒç”¨goparkï¼Œå°†å½“å‰goroutineè¿›å…¥gowaitçŠ¶æ€ï¼Œè§£é™¤å½“å‰hchançš„é” è¿›è¡Œé˜»å¡</span></span><br><span class="line">	gopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanReceive, traceEvGoBlockRecv, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// someone woke us up</span></span><br><span class="line">	<span class="keyword">if</span> mysg != gp.waiting &#123;</span><br><span class="line">		throw(<span class="string">"G waiting list is corrupted"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	gp.waiting = <span class="literal">nil</span></span><br><span class="line">	gp.activeStackChans = <span class="literal">false</span></span><br><span class="line">	<span class="keyword">if</span> mysg.releasetime &gt; <span class="number">0</span> &#123;</span><br><span class="line">		blockevent(mysg.releasetime-t0, <span class="number">2</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	closed := gp.param == <span class="literal">nil</span></span><br><span class="line">	gp.param = <span class="literal">nil</span></span><br><span class="line">	mysg.c = <span class="literal">nil</span></span><br><span class="line">	releaseSudog(mysg)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>, !closed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å…³é—­channel"><a href="#å…³é—­channel" class="headerlink" title="å…³é—­channel"></a>å…³é—­channel</h2><p><code>close(c)</code>è°ƒç”¨closeå‡½æ•°ä¼šå…³é—­chanelï¼Œç¼–è¯‘åä»£ç ä¼šè°ƒç”¨<code>closechan</code>å…³é—­chanel</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">closechan</span><span class="params">(c *hchan)</span></span> &#123;</span><br><span class="line">    <span class="comment">// å…³é—­ä¸€ä¸ªç©ºchannelæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">	<span class="keyword">if</span> c == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(plainError(<span class="string">"close of nil channel"</span>))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸Šé”</span></span><br><span class="line">	lock(&amp;c.lock)</span><br><span class="line">    <span class="comment">// å…³é—­å·²ç»å…³é—­çš„channelæŠ›å‡ºå¼‚å¸¸	</span></span><br><span class="line">    <span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">		unlock(&amp;c.lock)</span><br><span class="line">		<span class="built_in">panic</span>(plainError(<span class="string">"close of closed channel"</span>))</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®å…³é—­æ ‡è®°ä½</span></span><br><span class="line">	c.closed = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// goroutineé“¾è¡¨</span></span><br><span class="line">	<span class="keyword">var</span> glist gList</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä»ç­‰å¾…æ¥å—è€…é˜Ÿåˆ—ä¸­æ‰¾å‡ºæ‰€æœ‰æ¥å—è€…goroutine</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		sg := c.recvq.dequeue()</span><br><span class="line">		<span class="keyword">if</span> sg == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> sg.elem != <span class="literal">nil</span> &#123;</span><br><span class="line">			typedmemclr(c.elemtype, sg.elem)</span><br><span class="line">			sg.elem = <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> sg.releasetime != <span class="number">0</span> &#123;</span><br><span class="line">			sg.releasetime = cputicks()</span><br><span class="line">		&#125;</span><br><span class="line">		gp := sg.g</span><br><span class="line">		gp.param = <span class="literal">nil</span></span><br><span class="line">		<span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">			raceacquireg(gp, c.raceaddr())</span><br><span class="line">		&#125;</span><br><span class="line">		glist.push(gp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä»ç­‰å¾…æ¥å—è€…é˜Ÿåˆ—ä¸­æ‰¾å‡ºæ‰€æœ‰æ¥å—è€…goroutine</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		sg := c.sendq.dequeue()</span><br><span class="line">		<span class="keyword">if</span> sg == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		sg.elem = <span class="literal">nil</span></span><br><span class="line">		<span class="keyword">if</span> sg.releasetime != <span class="number">0</span> &#123;</span><br><span class="line">			sg.releasetime = cputicks()</span><br><span class="line">		&#125;</span><br><span class="line">		gp := sg.g</span><br><span class="line">		gp.param = <span class="literal">nil</span></span><br><span class="line">		<span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">			raceacquireg(gp, c.raceaddr())</span><br><span class="line">		&#125;</span><br><span class="line">		glist.push(gp)</span><br><span class="line">	&#125;</span><br><span class="line">	unlock(&amp;c.lock)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// éå†é“¾è¡¨ï¼Œé€ä¸ªè°ƒç”¨goreadyï¼Œå”¤é†’å™¨goroutine</span></span><br><span class="line">	<span class="keyword">for</span> !glist.empty() &#123;</span><br><span class="line">		gp := glist.pop()</span><br><span class="line">		gp.schedlink = <span class="number">0</span></span><br><span class="line">		goready(gp, <span class="number">3</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="selectå…³é”®å­—"><a href="#selectå…³é”®å­—" class="headerlink" title="selectå…³é”®å­—"></a>selectå…³é”®å­—</h2><p> ä½¿ç”¨selectå…³é”®å­—å¯ä»¥ä»caseä¸­ä»»ä¸€ä¸ªå¯è¯»æˆ–å¯å†™çš„channelè¿›è¡Œæ“ä½œï¼Œæœ‰ç‚¹åƒioä¸­selectæ¨¡å‹ã€‚å…¶ä¸­ä¼šåˆ†ä¸ºå››ç§æƒ…å†µ</p>
<ol>
<li>ç©ºcaseå¦‚<code>select{}</code></li>
<li>å•caseï¼Œå¦‚ <code>selct{case &lt;-c: }</code></li>
<li>ä¸¤ä¸ªcaseä¸€ä¸ªchannelä¸€ä¸ªdefaultï¼Œå¦‚<code>select{case &lt;-c: ;default:}</code></li>
<li>å¤šcaseï¼Œé™¤ä¸Šè¿°ä»»æ„æƒ…å†µï¼Œè¿™ä¸ªæƒ…å†µè°ƒç”¨<code>selectgo</code>å‡½æ•°</li>
</ol>
<h3 id="ç©ºcase"><a href="#ç©ºcase" class="headerlink" title="ç©ºcase"></a>ç©ºcase</h3><p> ç©ºcaseæ—¶å€™ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨ä¼šåšå¤„ç†ï¼Œè¿™ä¸ªæ—¶å€™ç›´æ¥è°ƒç”¨blockå‡½æ•°ï¼Œè®©å½“å‰goroutineå¤„äºé˜»å¡çŠ¶æ€</p>
<h3 id="å•case"><a href="#å•case" class="headerlink" title="å•case"></a>å•case</h3><p> è¿™ä¸ªæ—¶å€™ç¼–è¯‘å™¨åšå¤„ç†ï¼Œå°†å•caseæƒ…å†µï¼Œè½¬æ¢æˆå¯¹å•ä¸ªchanelè¯»æˆ–å†™, <code>selct{case &lt;-c: }</code>è½¬æ¢æˆ<code>&lt;-c</code>,<code>selct{case c&lt;-1: }</code>è½¬æ¢æˆ<code>c&lt;-1</code></p>
<h3 id="ä¸¤ä¸ªcaseä¸€ä¸ªchannelä¸€ä¸ªdefault"><a href="#ä¸¤ä¸ªcaseä¸€ä¸ªchannelä¸€ä¸ªdefault" class="headerlink" title="ä¸¤ä¸ªcaseä¸€ä¸ªchannelä¸€ä¸ªdefault"></a>ä¸¤ä¸ªcaseä¸€ä¸ªchannelä¸€ä¸ªdefault</h3><p> è¿™ä¸ªæ—¶å€™å°±ä¼šç”¨åˆ°ï¼Œä¸Šé¢å‘é€æˆ–æ¥æ”¶ä¸­çš„éé˜»å¡çŠ¶æ€ï¼Œç¼–è¯‘å™¨å¤„ç†å¦‚ä¸‹</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">select</span> &#123;</span><br><span class="line">   <span class="keyword">case</span> &lt;-c:</span><br><span class="line">   <span class="keyword">default</span>:</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç­‰ä»·å¦‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="keyword">go</span></span><br><span class="line">_, ok := chanrecv(hch, data, <span class="literal">false</span>, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line"><span class="comment">// caseä¸­xxx</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// defaultä¸­xxx</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="selectgo-å‡½æ•°"><a href="#selectgo-å‡½æ•°" class="headerlink" title="selectgo å‡½æ•°"></a>selectgo å‡½æ•°</h2><p> selctä¸­å…¶ä»–æƒ…å†µä¼šè°ƒç”¨åˆ°è¿™ä¸ªå‡½æ•°ï¼Œé¦–å…ˆå°†caseåŒ…è£…æˆscaseç»“æ„</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	caseNil = <span class="literal">iota</span></span><br><span class="line">	caseRecv</span><br><span class="line">	caseSend</span><br><span class="line">	caseDefault</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> scase <span class="keyword">struct</span> &#123;</span><br><span class="line">	c           *hchan         <span class="comment">// caseä¸­çš„channelï¼ŒcaseDefaultæ—¶å€™ä¸ºnil</span></span><br><span class="line">	elem        unsafe.Pointer <span class="comment">// data element</span></span><br><span class="line">	kind        <span class="keyword">uint16</span> <span class="comment">// kind ç§ç±» æœ‰æ¥æ”¶ç±»å‹ è¯»å–ç±»å‹å’ŒDefault,å¯¹åº”caseä¸­æ“ä½œ</span></span><br><span class="line">	pc          <span class="keyword">uintptr</span> <span class="comment">// race pc (for race detector / msan)</span></span><br><span class="line">	releasetime <span class="keyword">int64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨<code>selectgo</code>å‡½æ•°ï¼Œä¼šä¿è¯å¯¹æ¯ä¸€ä¸ªcaseéšæœºï¼Œä¸ä¼šä¼˜å…ˆåˆ¤æ–­æŸä¸ªcase<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// è¾“å…¥çš„caseæ•°ç»„</span></span><br><span class="line">   cas1 := (*[<span class="number">1</span> &lt;&lt; <span class="number">16</span>]scase)(unsafe.Pointer(cas0))</span><br><span class="line">   <span class="comment">// åˆ¤æ–­caseçš„é¡ºåº</span></span><br><span class="line">order1 := (*[<span class="number">1</span> &lt;&lt; <span class="number">17</span>]<span class="keyword">uint16</span>)(unsafe.Pointer(order0))</span><br><span class="line"></span><br><span class="line">scases := cas1[:ncases:ncases]</span><br><span class="line">pollorder := order1[:ncases:ncases]</span><br><span class="line">   <span class="comment">// channelä¸Šé”é¡ºåº</span></span><br><span class="line">lockorder := order1[ncases:][:ncases:ncases]</span><br><span class="line"></span><br><span class="line"><span class="comment">// Replace send/receive cases involving nil channels with</span></span><br><span class="line"><span class="comment">// caseNil so logic below can assume non-nil channel.</span></span><br><span class="line">   <span class="comment">// æ£€æŸ¥scasesï¼Œä¸ºcaseDefaultç±»å‹èµ‹å€¼ä¸€ä¸ªç©ºstruct</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> scases &#123;</span><br><span class="line">	cas := &amp;scases[i]</span><br><span class="line">	<span class="keyword">if</span> cas.c == <span class="literal">nil</span> &amp;&amp; cas.kind != caseDefault &#123;</span><br><span class="line">		*cas = scase&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¿è¯éšæœºæ‰“æ•£orderï¼Œå’Œæ‰“æ•£channelä¸Šé”é¡ºåº<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generate permuted order</span></span><br><span class="line">   <span class="comment">// ä½¿ç”¨fastrandnå‡½æ•°æ‰“ä¹±order</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt; ncases; i++ &#123;</span><br><span class="line">	j := fastrandn(<span class="keyword">uint32</span>(i + <span class="number">1</span>))</span><br><span class="line">	pollorder[i] = pollorder[j]</span><br><span class="line">	pollorder[j] = <span class="keyword">uint16</span>(i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®æ¯ä¸ªcaseä¸­çš„channelçš„åœ°å€æ¥åšæ€¼æ’åºå†³å®šä¸Šé”é¡ºåº</span></span><br><span class="line">   <span class="comment">// å› ä¸ºå†…å­˜ä¸­åœ°å€æ¯”è¾ƒéšæœºï¼Œå¯ä»¥è®¤ä¸ºæ˜¯éšæœºçš„é¡ºåº</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; ncases; i++ &#123;</span><br><span class="line">	j := i</span><br><span class="line">	<span class="comment">// Start with the pollorder to permute cases on the same channel.</span></span><br><span class="line">	c := scases[pollorder[i]].c</span><br><span class="line">	<span class="keyword">for</span> j &gt; <span class="number">0</span> &amp;&amp; scases[lockorder[(j<span class="number">-1</span>)/<span class="number">2</span>]].c.sortkey() &lt; c.sortkey() &#123;</span><br><span class="line">		k := (j - <span class="number">1</span>) / <span class="number">2</span></span><br><span class="line">		lockorder[j] = lockorder[k]</span><br><span class="line">		j = k</span><br><span class="line">	&#125;</span><br><span class="line">	lockorder[j] = pollorder[i]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i := ncases - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">	o := lockorder[i]</span><br><span class="line">	c := scases[o].c</span><br><span class="line">	lockorder[i] = lockorder[<span class="number">0</span>]</span><br><span class="line">	j := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		k := j*<span class="number">2</span> + <span class="number">1</span></span><br><span class="line">		<span class="keyword">if</span> k &gt;= i &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> k+<span class="number">1</span> &lt; i &amp;&amp; scases[lockorder[k]].c.sortkey() &lt; scases[lockorder[k+<span class="number">1</span>]].c.sortkey() &#123;</span><br><span class="line">			k++</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> c.sortkey() &lt; scases[lockorder[k]].c.sortkey() &#123;</span><br><span class="line">			lockorder[j] = lockorder[k]</span><br><span class="line">			j = k</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	&#125;</span><br><span class="line">	lockorder[j] = o</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®é”é¡ºåºä¸Šé”</span></span><br><span class="line">sellock(scases, lockorder)</span><br></pre></td></tr></table></figure></p>
<p>åˆ¤æ–­æ¯ä¸€ä¸ªcaseæ˜¯å¦å¯ä»¥æ‰§è¡Œï¼Œè¿™é‡Œæ˜¯<code>selectgo</code>å‡½æ•°çš„å…³é”®éƒ¨åˆ†<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">loop:</span><br><span class="line">	<span class="comment">// pass 1 - look for something already waiting</span></span><br><span class="line">	<span class="keyword">var</span> dfli <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">var</span> dfl *scase</span><br><span class="line">	<span class="keyword">var</span> casi <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">var</span> cas *scase</span><br><span class="line">	<span class="keyword">var</span> recvOK <span class="keyword">bool</span></span><br><span class="line">    <span class="comment">// éå†ncases è¿™ä¸ªæ—¶å€™caseå·²ç»è¢«æ‰“ä¹±</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; ncases; i++ &#123;</span><br><span class="line">		casi = <span class="keyword">int</span>(pollorder[i])</span><br><span class="line">		cas = &amp;scases[casi]</span><br><span class="line">		c = cas.c</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> cas.kind &#123;</span><br><span class="line">		<span class="keyword">case</span> caseNil:</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> caseRecv:</span><br><span class="line">            <span class="comment">// åˆ¤æ–­å‘é€ç­‰å¾…é˜Ÿåˆ—æ˜¯å¦æœ‰å‘é€è€…è‹¥æœ‰ï¼Œrecvæ“ä½œå’Œchannelæ“ä½œä¸€æ ·</span></span><br><span class="line">            sg = c.sendq.dequeue()</span><br><span class="line">			<span class="keyword">if</span> sg != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">goto</span> recv</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­bufæ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºä»bufè¯»</span></span><br><span class="line">			<span class="keyword">if</span> c.qcount &gt; <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">goto</span> bufrecv</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">                <span class="comment">// ä»å·²ç»å…³é—­channelè¯»è¿™é‡Œä¼šè¿”å›</span></span><br><span class="line">				<span class="keyword">goto</span> rclose</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> caseSend:</span><br><span class="line">            <span class="comment">// channelå·²ç»å…³é—­ï¼Œè¿™é‡Œä¼španic</span></span><br><span class="line">			<span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">goto</span> sclose</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">// ä»æ¥æ”¶è€…ç­‰å¾…é˜Ÿåˆ—è·å–ï¼Œè‹¥æœ‰æ¥å—è€…åˆ™å‘é€å’Œå‘é€channelæµç¨‹ä¸€æ ·</span></span><br><span class="line">            sg = c.recvq.dequeue()</span><br><span class="line">			<span class="keyword">if</span> sg != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">goto</span> send</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­bufæ˜¯å¦æ»¡äº†ï¼Œæœªæ»¡å†™å…¥bufï¼Œå’Œå†™å…¥channelbufæµç¨‹ä¸€æ ·</span></span><br><span class="line">			<span class="keyword">if</span> c.qcount &lt; c.dataqsiz &#123;</span><br><span class="line">				<span class="keyword">goto</span> bufsend</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> caseDefault:</span><br><span class="line">            <span class="comment">// å…ˆèµ‹å€¼defaultï¼Œcase</span></span><br><span class="line">			dfli = casi</span><br><span class="line">			dfl = cas</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// éå†caseç»“æŸï¼Œèµ°åˆ°è¿™é‡Œï¼Œæ˜¯æ¯ä¸€ä¸ªcaseä¸­çš„channeléƒ½æ²¡æœ‰ä¸€ä¸ªç¬¦åˆ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰defaultï¼Œcaseæœ‰åˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">	<span class="keyword">if</span> dfl != <span class="literal">nil</span> &#123;</span><br><span class="line">		selunlock(scases, lockorder)</span><br><span class="line">		casi = dfli</span><br><span class="line">		cas = dfl</span><br><span class="line">		<span class="keyword">goto</span> retc</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœæ²¡æœ‰default caseä¸”caseä¸­ä¹Ÿæ²¡æœ‰ä¸€ä¸ªchannelç¬¦åˆè¦æ±‚ï¼Œè¿™ä¸ªæ—¶å€™ä¼šé˜»å¡<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–å½“å‰goroutine</span></span><br><span class="line">gp = getg()</span><br><span class="line">   <span class="comment">// å¦‚æœä¸€ä¸ªæœ‰ä¸€ä¸ªç­‰å¾…æ—¶é—´æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="keyword">if</span> gp.waiting != <span class="literal">nil</span> &#123;</span><br><span class="line">	throw(<span class="string">"gp.waiting != nil"</span>)</span><br><span class="line">&#125;</span><br><span class="line">nextp = &amp;gp.waiting</span><br><span class="line">   <span class="comment">// æŒ‰ç…§å…¥é”é¡ºåºéå†</span></span><br><span class="line"><span class="keyword">for</span> _, casei := <span class="keyword">range</span> lockorder &#123;</span><br><span class="line">	casi = <span class="keyword">int</span>(casei)</span><br><span class="line">	cas = &amp;scases[casi]</span><br><span class="line">	<span class="keyword">if</span> cas.kind == caseNil &#123;</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	&#125;</span><br><span class="line">	c = cas.c</span><br><span class="line">	sg := acquireSudog()</span><br><span class="line">	sg.g = gp</span><br><span class="line">	sg.isSelect = <span class="literal">true</span></span><br><span class="line">	sg.elem = cas.elem</span><br><span class="line">	sg.releasetime = <span class="number">0</span></span><br><span class="line">	<span class="keyword">if</span> t0 != <span class="number">0</span> &#123;</span><br><span class="line">		sg.releasetime = <span class="number">-1</span></span><br><span class="line">	&#125;</span><br><span class="line">	sg.c = c</span><br><span class="line">	<span class="comment">// Construct waiting list in lock order.</span></span><br><span class="line">	*nextp = sg</span><br><span class="line">	nextp = &amp;sg.waitlink</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">switch</span> cas.kind &#123;</span><br><span class="line">       <span class="comment">// å¦‚æœæ˜¯æ¥æ”¶ï¼Œè¿›å…¥hchçš„æ¥å—è€…ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">	<span class="keyword">case</span> caseRecv:</span><br><span class="line">		c.recvq.enqueue(sg)</span><br><span class="line">       <span class="comment">// å¦‚æœæ˜¯å‘é€ï¼Œè¿›å…¥hchçš„å‘é€è€…ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">	<span class="keyword">case</span> caseSend:</span><br><span class="line">		c.sendq.enqueue(sg)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾…è¢«å”¤é†’</span></span><br><span class="line">gp.param = <span class="literal">nil</span></span><br><span class="line">gopark(selparkcommit, <span class="literal">nil</span>, waitReasonSelect, traceEvGoBlockSelect, <span class="number">1</span>)</span><br><span class="line">gp.activeStackChans = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// é‡æ–°è·å–é”</span></span><br><span class="line">sellock(scases, lockorder)</span><br><span class="line"></span><br><span class="line">gp.selectDone = <span class="number">0</span></span><br><span class="line">sg = (*sudog)(gp.param)</span><br><span class="line">gp.param = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// pass 3 - dequeue from unsuccessful chans</span></span><br><span class="line"><span class="comment">// otherwise they stack up on quiet channels</span></span><br><span class="line"><span class="comment">// record the successful case, if any.</span></span><br><span class="line"><span class="comment">// We singly-linked up the SudoGs in lock order.</span></span><br><span class="line">casi = <span class="number">-1</span></span><br><span class="line">cas = <span class="literal">nil</span></span><br><span class="line">sglist = gp.waiting</span><br><span class="line"><span class="comment">// Clear all elem before unlinking from gp.waiting.</span></span><br><span class="line"><span class="keyword">for</span> sg1 := gp.waiting; sg1 != <span class="literal">nil</span>; sg1 = sg1.waitlink &#123;</span><br><span class="line">	sg1.isSelect = <span class="literal">false</span></span><br><span class="line">	sg1.elem = <span class="literal">nil</span></span><br><span class="line">	sg1.c = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">gp.waiting = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// æŒ‰ç…§ä¸Šé”é¡ºåºéå†ï¼Œ</span></span><br><span class="line">   <span class="comment">// å…¶ä½™goroutineå‡ºé˜Ÿ</span></span><br><span class="line"><span class="keyword">for</span> _, casei := <span class="keyword">range</span> lockorder &#123;</span><br><span class="line">	k = &amp;scases[casei]</span><br><span class="line">	<span class="keyword">if</span> k.kind == caseNil &#123;</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> sglist.releasetime &gt; <span class="number">0</span> &#123;</span><br><span class="line">		k.releasetime = sglist.releasetime</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> sg == sglist &#123;</span><br><span class="line">		<span class="comment">// sg has already been dequeued by the G that woke us up.</span></span><br><span class="line">		casi = <span class="keyword">int</span>(casei)</span><br><span class="line">		cas = k</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		c = k.c</span><br><span class="line">		<span class="keyword">if</span> k.kind == caseSend &#123;</span><br><span class="line">			c.sendq.dequeueSudoG(sglist)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			c.recvq.dequeueSudoG(sglist)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	sgnext = sglist.waitlink</span><br><span class="line">	sglist.waitlink = <span class="literal">nil</span></span><br><span class="line">	releaseSudog(sglist)</span><br><span class="line">	sglist = sgnext</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p> channelæ˜¯golangå®ç°CSPç†è®ºçš„å…³é”®éƒ¨åˆ†ï¼Œç»“åˆselectå’Œchannelæºç èƒ½æ›´å¥½ç†è§£channel</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/golang/" rel="tag"># golang</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/08/29/slice/" rel="next" title="golang slice">
                <i class="fa fa-chevron-left"></i> golang slice
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/09/06/map/" rel="prev" title="golang map">
                golang map <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="é»„å°‘æ°">
            
              <p class="site-author-name" itemprop="name">é»„å°‘æ°</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">æ—¥å¿—</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">åˆ†ç±»</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">æ ‡ç­¾</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/Socketsj" title="GitHub &rarr; https://github.com/Socketsj" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:282048277@qq.com" title="E-Mail &rarr; mailto:282048277@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#channel-ç»“æ„"><span class="nav-number">1.</span> <span class="nav-text">channel ç»“æ„</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åˆ›å»ºchannel"><span class="nav-number">2.</span> <span class="nav-text">åˆ›å»ºchannel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¾€channelå‘é€æ•°æ®"><span class="nav-number">3.</span> <span class="nav-text">å¾€channelå‘é€æ•°æ®</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä»channelè¯»å–æ•°æ®"><span class="nav-number">4.</span> <span class="nav-text">ä»channelè¯»å–æ•°æ®</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å…³é—­channel"><span class="nav-number">5.</span> <span class="nav-text">å…³é—­channel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#selectå…³é”®å­—"><span class="nav-number">6.</span> <span class="nav-text">selectå…³é”®å­—</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ç©ºcase"><span class="nav-number">6.1.</span> <span class="nav-text">ç©ºcase</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å•case"><span class="nav-number">6.2.</span> <span class="nav-text">å•case</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸¤ä¸ªcaseä¸€ä¸ªchannelä¸€ä¸ªdefault"><span class="nav-number">6.3.</span> <span class="nav-text">ä¸¤ä¸ªcaseä¸€ä¸ªchannelä¸€ä¸ªdefault</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#selectgo-å‡½æ•°"><span class="nav-number">7.</span> <span class="nav-text">selectgo å‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å°ç»“"><span class="nav-number">8.</span> <span class="nav-text">å°ç»“</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 â€“ <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">é»„å°‘æ°</span>

  

  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/affix.js?v=7.1.0"></script>

  <script src="/js/schemes/pisces.js?v=7.1.0"></script>



  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
